<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carparks and POS Sites</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <h1 class="navbar-title">Carparks Sites</h1>
            <div class="navbar-actions">
                <button class="button add" onclick="openAddCarparkModal()">Add Carpark</button>
            </div>
        </div>
    </nav>

    <div class="container">
        {% for carpark in carparks %}
        <div class="accordion">
            <div class="accordion-header" onclick="toggleAccordion(this)">
                <div class="accordion-header-content">
                    <h2>{{ carpark.name }} - {{ carpark.id }}</h2>
                    <div class="accordion-actions">
                        <button class="button add"
                            onclick="openAddModal('{{ carpark.id }}', '{{ carpark.name }}'); event.stopPropagation();">Add
                            New POS</button>
                        <button class="button delete"
                            onclick="confirmDeleteCarpark('{{ carpark.id }}'); event.stopPropagation();">Delete
                            Carpark</button>
                    </div>
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="accordion-content">
                <div class="card-container">
                    {% if carpark.pos %}
                    {% for pos in carpark.pos %}
                    <div class="card">
                        <div class="card-body">
                            <div class="card-content">
                                <div class="card-info">
                                    <div class="card-info-container">
                                        <div class="card-header-container">
                                            <div class="card-title-container">
                                                <h3 class="card-title">{{ pos.name }} - </h3>
                                                <span class="card-ip">{{ pos.ip }}</span>
                                                <button class="button edit"
                                                    onclick="openEditModal('{{ pos.name }}', '{{ pos.name }}', '{{ carpark.name }}', '{{ pos.ip }}', '{{ pos.password }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button> 

                                                <button class="button delete"
                                                    onclick="confirmDelete('{{ carpark.id }}', '{{ pos.name }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button class="button load"
                                                    onclick="loadCardData('{{ carpark.id }}', '{{ pos.name }}')">
                                                    <i class="fas fa-sync-alt"></i> 
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="card-services" id="services-{{ carpark.id }}-{{ pos.name }}"
                                style="display: none;">
                                <table id="servicesTable-{{ carpark.id }}-{{ pos.name }}" class="services-table">
                                    <caption>Docker Services</caption>
                                    <thead>
                                        <tr>
                                            <th>Service Name</th>
                                            <th>Image Name</th>
                                            <th>Version</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be inserted here -->
                                    </tbody>
                                </table>
                                <br>
                                <button class="button view-compose"
                                    onclick="viewDockerCompose('{{ carpark.id }}', '{{ pos.name }}')">
                                    View Docker Compose
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p>No POS found. Please add a POS.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>




    <!-- Add this new modal for confirming carpark deletion -->
    <div id="confirmDeleteCarparkModal" class="modal animate__animated animate__fadeIn">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Carpark Deletion</h2>
                <span class="close" onclick="closeModal('confirmDeleteCarparkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this carpark? This action cannot be undone.</p>
                <div class="modal-buttons">
                    <button id="confirmDeleteCarparkBtn" class="button delete">Delete</button>
                    <button class="button cancel" onclick="closeModal('confirmDeleteCarparkModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal animate__animated animate__fadeIn">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit POS Configuration</h2>
                <span class="close" onclick="closeModal('editModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editForm" method="post">
                    <input type="hidden" id="editCarparkId" name="carpark_id">
                    <input type="hidden" id="editPosName" name="pos_name">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="site">Site:</label>
                        <input type="text" id="site" name="site" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="ip">IP Address:</label>
                        <input type="text" id="ip" name="ip" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" name="username" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="text" id="password" name="password" class="form-control">
                    </div>
                    <br>
                    <button type="submit" class="button save">Save</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Modal -->
    <div id="addModal" class="modal animate__animated animate__fadeIn">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New POS</h2>
                <span class="close" onclick="closeModal('addModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addForm" method="post">
                    <input type="hidden" id="addCarparkId" name="carpark_id">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="site">Site:</label>
                        <input type="text" id="site" name="site" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="ip">IP Address:</label>
                        <input type="text" id="ip" name="ip" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" name="username" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="text" id="password" name="password" class="form-control">
                    </div>
                    <br>
                    <button type="submit" class="button add">Add POS</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmDeleteModal" class="modal animate__animated animate__fadeIn">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
                <span class="close" onclick="closeModal('confirmDeleteModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this POS?</p>
                <div class="modal-buttons">
                    <button id="confirmDeleteBtn" class="button delete">Delete</button>
                    <button class="button cancel" onclick="closeModal('confirmDeleteModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Docker Compose Modal -->
    <div id="dockerComposeModal" class="modal animate__animated animate__fadeIn">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Docker Compose Data</h2>
                <span class="close" onclick="closeModal('dockerComposeModal')">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="dockerComposeData"></pre>
            </div>
        </div>
    </div>


    <!-- Add Carpark Modal -->
    <div id="addCarparkModal" class="modal animate__animated animate__fadeIn">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Carpark</h2>
                <span class="close" onclick="closeModal('addCarparkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addCarparkForm" method="post" action="/add_carpark">
                    <div class="form-group">
                        <label for="carparkId">Carpark ID:</label>
                        <input type="number" id="carparkId" name="carpark_id" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="carparkName">Carpark Name:</label>
                        <input type="text" id="carparkName" name="carpark_name" class="form-control" required>
                    </div>
                    <br>
                    <button type="submit" class="button add">Add Carpark</button>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
    <script>
        function toggleAccordion(header) {
            header.classList.toggle("active");
            var content = header.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        }

        function confirmDeleteCarpark(carparkId) {
            const modal = document.getElementById('confirmDeleteCarparkModal');
            const confirmBtn = document.getElementById('confirmDeleteCarparkBtn');
            confirmBtn.onclick = function () {
                window.location.href = `/delete_carpark/${carparkId}`;
            };
            modal.style.display = 'flex';
        }

        function confirmDelete(carparkId, posName) {
            const modal = document.getElementById('confirmDeleteModal');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = function () {
                window.location.href = `/delete/${carparkId}/${posName}`;
            };
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        function openEditModal(carparkId, name, site, ip, username, password) {
            document.getElementById('editForm').action = `/edit/${carparkId}/${name}`;
            document.getElementById('editCarparkId').value = carparkId;
            document.getElementById('editPosName').value = name;
            document.getElementById('name').value = name;
            document.getElementById('site').value = site;
            document.getElementById('ip').value = ip;
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;

            document.getElementById('editModal').style.display = 'flex';
        }

        function openAddModal(carparkId, carparkName) {
            document.getElementById('addForm').action = `/add/${carparkId}`;
            document.getElementById('addCarparkId').value = carparkId;
            document.getElementById('site').value = carparkName;
            document.getElementById('addModal').style.display = 'flex';
        }

        function loadCardData(carparkId, posName) {
            const servicesContainer = document.getElementById(`services-${carparkId}-${posName}`);
            const servicesTable = servicesContainer.querySelector('table tbody');
            servicesTable.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
            servicesContainer.style.display = 'block';

            fetch(`/load_data/${carparkId}/${posName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        servicesTable.innerHTML = '';
                        data.services.forEach(service => {
                            const serviceName = service.name;
                            const imageAndVersion = service.image.split(':');
                            const imageName = imageAndVersion[0];
                            const version = imageAndVersion[1] || 'N/A';

                            const row = document.createElement('tr');
                            row.innerHTML = `
                        <td>${serviceName}</td>
                        <td>${imageName}</td>
                        <td>${version}</td>
                    `;
                            servicesTable.appendChild(row);
                        });

                        // Open the accordion dynamically
                        const accordionHeader = servicesContainer.closest('.accordion').querySelector('.accordion-header');
                        if (!accordionHeader.classList.contains('active')) {
                            toggleAccordion(accordionHeader);
                        }
                    } else {
                        servicesTable.innerHTML = `<tr><td colspan="3">Error: ${data.message}</td></tr>`;
                    }
                })
                .catch(error => {
                    servicesTable.innerHTML = `<tr><td colspan="3">Error: ${error.message}</td></tr>`;
                });
        }

        function viewDockerCompose(carparkId, posName) {
            fetch(`/load_data/${carparkId}/${posName}`)
                .then(response => response.text()) // Get response as text
                .then(data => {
                    // Ensure the Docker Compose modal takes up full screen
                    const modal = document.getElementById('dockerComposeModal');
                    const dockerComposeData = data; // Data is already in YAML format

                    // Display the YAML content in the modal
                    document.getElementById('dockerComposeData').textContent = dockerComposeData;

                    // Display the modal
                    modal.style.display = 'flex';
                })
                .catch(error => {
                    alert(`Error: ${error.message}`);
                });
        }



        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        function toggleAccordion(header) {
            header.classList.toggle("active");
            var content = header.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        }


        function openAddCarparkModal() {
            document.getElementById('addCarparkModal').style.display = 'flex';
        }

    </script>
</body>

</html>